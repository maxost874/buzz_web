<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Buzz Predictor — Live</title>
<script>
  /* ←← עדכן כאן רק שתי השורות ↓↓↓ */
  const API_BASE = "https://buzz-api-bbtg.onrender.com";      // כתובת ה-API שלך ב-Render
  const DASHBOARD_URL = "https://app.powerbi.com/groups/<workspace-id>/reports/<report-id>/ReportSection?pageName=<page-id>";
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* צבעים */
  :root{
    --bg-outer:#bfe0b6;      /* רקע ירוק בהיר מסביב */
    --panel:#f3fbf2;         /* פנים הלוח */
    --frame:#2e5d2e;         /* מסגרת ירוקה כהה */
    --headline:#0b6623;      /* פס כותרת כהה */
    --brand:#2F5597;
    --ok:#2E7D32; --bad:#C62828; --muted:#616161;
  }

  /* רקע מסך עם “כרית” */
  html,body{height:100%}
  body{
    margin:0; padding:28px;
    background: radial-gradient(ellipse at center, var(--bg-outer) 0%, #cde9c7 100%);
    font-family: system-ui, -apple-system, Segoe UI, Roboto;
    color:#0f172a;
    display:flex; align-items:center; justify-content:center;
  }

  /* לוח מרכזי + מסגרת */
  .frame{
    width:min(1180px, 96vw);
    background:var(--bg-outer);
    border-radius:18px;
    box-shadow:0 16px 40px rgba(0,0,0,.18);
    padding:14px;
  }
  .panel{
    background:var(--panel);
    border:4px solid var(--frame);
    border-radius:14px;
    padding:18px 18px 26px;
  }

  /* פס כותרת */
  .header{
    position:relative;
    background:var(--headline);
    border:2px solid #0a0a0a;
    color:#fff;
    font-weight:800;
    font-size:clamp(20px, 2.6vw, 34px);
    text-align:center;
    padding:16px 60px;
    border-radius:6px;
  }
  .header .left, .header .right{
    position:absolute; top:50%; transform:translateY(-50%);
    width:42px; height:42px; object-fit:contain;
  }
  .header .left{ left:14px; }
  .header .right{ right:14px; }

  .subline{
    margin:14px 0 10px;
    padding-bottom:8px;
    border-bottom:4px solid var(--frame);
    color:#2f4f2f;
    text-align:center;
    font-size:16px;
  }

  /* תווית לשדה הטקסט – מיושר שמאלה */
  .post-label{
    display:block;
    margin:0 0 6px;
    text-align:left;
    direction:ltr;
    font-weight:700;
  }

  /* כרטיסים, טקסט, כפתורים */
   .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* בדיוק 4 עמודות */
      gap: 20px;
  }


  .card{background:#fff; border-radius:12px; padding:18px; box-shadow:0 2px 10px rgba(0,0,0,.06)}

    /* ----- Metric Card (Accuracy) ----- */
  .metric-card{
    text-align:center;
    min-height:220px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .metric-title{
    font-weight:800;
  }
  .metric-value{
    font-size:clamp(28px, 4vw, 44px);
    font-weight:900;
    color:#0f172a;
    padding:12px 20px;
    border-radius:14px;
    border:3px solid #2E7D32;
    background:#e8f5e9;
    box-shadow: inset 0 0 0 4px #d9f0dc;
  }
  .metric-sub{
    color:#475569;
    font-size:14px;
  }

  textarea {
    width: 100%;           /* יתפוס את כל הרוחב של הכרטיס */
    max-width: 100%;
    min-height: 120px;     /* גובה התחלתי – שורה וחצי-שתיים */
    margin: 10px auto;
    display: block;
    box-sizing: border-box;
  
    /* כתיבה LTR */
    direction: ltr;
    text-align: left;
    unicode-bidi: plaintext;
  
    resize: vertical;      /* אפשרות למשתמש להגדיל/להקטין רק בגובה */
  }


  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .btn,button{
    padding:10px 16px;border:0;border-radius:10px;background:var(--brand);color:#fff;
    font-weight:700;cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.12)
  }
  .btn.ghost{background:#e2e8f0;color:#111}

  /* Back button */
  .back-btn{
    display:inline-flex; align-items:center; gap:8px; padding:10px 18px;
    background:#e9eef5; border-radius:10px; font-weight:800; color:#0f172a;
    text-decoration:none; box-shadow:0 2px 8px rgba(0,0,0,.12); transition:all .2s ease;
  }
  .back-btn:hover{ background:#dfe7f3; transform:translateY(-2px); }
  .back-btn .arrow{ line-height:1 }
  [dir="rtl"] .back-btn .arrow::before{ content:"\2190"; } /* ← */
  [dir="ltr"] .back-btn .arrow::before{ content:"\2192"; } /* → */

  .pill{padding:6px 10px;border-radius:999px;font-weight:700;background:#eee}
  .pill.ok{color:var(--ok);background:#e8f5e9}
  .pill.bad{color:var(--bad);background:#fdecec}
  .pill.muted{color:var(--muted);background:#f3f4f6}

  /* KPI */
 
  /* KPI – יישור נקי: label בצד ימין, value משמאל */
  .kpi-card{
    display:grid;
    gap:16px;
    font-size:18px;
    padding:20px;
  }
  .kpi-row{
    display: grid;
    grid-template-columns: 1fr auto; /* קודם כותרת (שמאל), ואז ערך (ימין) */
    align-items: center;
    column-gap: 14px;
    direction: ltr;                 /* הופך את זרימת ה-grid לשמאל→ימין רק בשורה הזו */
  }
  .kpi-label{
    font-weight:800;
    color:#16351a;
    text-align: left;               /* הכותרת לשמאל */
  }

  .kpi-value{
    font-weight:700;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: flex-end;      /* הערך “נדבק” לימין השורה */
    text-align: right;
    direction: ltr;
  }

    /* כרטיסי גרפים קבועים בגובה */
  .card.chart{
    min-height: 320px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  
  /* הקנבסים עצמם – רוחב מלא + גובה קבוע */
  .card.chart canvas{
    display: block;
    width: 100% !important;
    height: 260px !important;  /* שנה ל-240/280 אם תרצה */
  }



  /* Progress */
  .progress{ height:10px; background:#ecf2ec; border-radius:999px; overflow:hidden; }
  .progress-fill{ height:100%; width:0%; transition:width .4s ease; }
  .progress-fill.low{  background:#f7b6b6; }
  .progress-fill.med{  background:#ffd07a; }
  .progress-fill.high{ background:#9ad29b; }

  .pill.sm{ padding:4px 8px; font-weight:800; }
</style>
</head>
<body>

  <!-- מסגרת ירוקה חיצונית -->
  <div class="frame">
    <div class="panel">
      <!-- פס כותרת + אייקונים -->
      <div class="header">
        <img class="left"  src="./reddit.png" alt="reddit">
        Buzz Predictor — Live
        <img class="right" src="./buzz.png"   alt="buzz">
      </div>
      <div class="subline">Fill in the details, analyze your content, and predict the buzz</div>

      <!-- טקסט + כפתורים -->
      <div class="card" style="margin-top:10px">
        <label for="txt" class="post-label">Post Text</label>
        <textarea id="txt" placeholder="Example: This post will explode today!"></textarea>
        <div class="row" style="margin-top:10px">
          <a class="back-btn" id="back" href="#"><span>Back to Dashboard</span><i class="arrow"></i></a>
          <button id="go">Predict</button>
        </div>
      </div>

      <!-- אזור תוצאות -->
      <div class="grid" id="results" style="display:none; margin-top:14px" aria-live="polite">
      
        <div class="card kpi-card">
          <div class="kpi-row">
            <div class="kpi-label">Prediction:</div>
            <div class="kpi-value">
              <span id="predPill" class="pill sm muted">–</span>
            </div>
          </div>
      
          <div class="kpi-row">
            <div class="kpi-label">Probability:</div>
            <div class="kpi-value"><span id="prob">–</span></div>
          </div>
          <div class="progress"><div id="probFill" class="progress-fill"></div></div>
      
          <div class="kpi-row">
            <div class="kpi-label">Sentiment:</div>
            <div class="kpi-value"><span id="sent" class="pill sm muted">–</span></div>
          </div>
        </div>
      
        <div class="card chart">
          <div><strong>Success Probability</strong></div>
          <canvas id="probChart"></canvas>
        </div>
      
        <div class="card chart">
          <div><strong>Sentiment Breakdown</strong></div>
          <canvas id="sentChart"></canvas>
        </div>
      
        <div class="card metric-card" id="accCard">
          <div class="metric-title">Model Accuracy</div>
          <div class="metric-value" id="accValue">70%</div>
        </div>
      
      </div> <!-- ← כאן נסגר ה-grid -->
      
      <!-- ===== AI Post Improver ===== -->
      <section id="improveSection" style="margin-top:24px;padding:16px;border:2px solid #2e5d2e;background:#f3fbf2;border-radius:16px">
        <h2 style="color:#0b6623;margin:0 0 8px">AI – Post upgrade</h2>
        <p style="margin:0 0 12px">Click to get a suggested title, 3 improved versions, and hashtags based on the text above.</p>
        <button id="improveBtn" style="padding:10px 16px;border-radius:10px;border:1px solid #2e5d2e;background:#2e5ד2e;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.12)">
           Upgrade my post ✨
        </button>
      
        <div id="improveArea" style="margin-top:14px;display:none">
          <h3 style="margin:10px 0 6px">כותרת מוצעת</h3>
          <div id="aiTitle" style="background:#fff;border:1px dashed #cfe3cf;padding:8px;border-radius:10px"></div>
      
          <h3 style="margin:14px 0 6px">נוסחים מוצעים</h3>
          <div id="aiSuggestions"></div>
      
          <h3 style="margin:14px 0 6px">#האשטגים</h3>
          <div id="aiTags" style="background:#fff;border:1px dashed #cfe3cf;padding:8px;border-radius:10px"></div>
        </div>
      </section>
      
      </div> <!-- ← כאן נסגרת .panel -->
      </div>   <!-- ← כאן נסגרת .frame -->


<script>
/* ======= JS ======= */
let probChart, sentChart;
const $ = id => document.getElementById(id);
$("back").href = DASHBOARD_URL;

async function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function wakeApi(maxTries=6){
  for(let i=1;i<=maxTries;i++){
    try{
      const r = await fetch(`${API_BASE}/health`, {method:"GET", mode:"cors"});
      if(r.ok) return true;
    }catch(e){}
    await sleep(i*1000);
  }
  return false;
}

/* פלאגין טקסט במרכז דונאט — עם ID ייחודי כדי למנוע כפילות */
function centerTextPlugin(text, id = "centerText_" + Math.random().toString(36).slice(2)){
  return {
    id,
    afterDraw(chart){
      const {ctx, chartArea:{left, right, top, bottom}} = chart;
      ctx.save();
      ctx.font = "700 18px system-ui";
      ctx.fillStyle = "#0f172a";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(text, (left+right)/2, (top+bottom)/2);
      ctx.restore();
    }
  };
}

async function predict(){
  const t = $("txt").value.trim();
  if(!t){ alert("הכנס טקסט"); return; }

  const btn=$("go"); btn.disabled=true; btn.textContent="...Predicting";
  try{
    const ok = await wakeApi();
    if(!ok) throw new Error("API not responding (health).");

    // GET ללא preflight (עוקף CORS)
    const r = await fetch(`${API_BASE}/predict_qs?text=${encodeURIComponent(t)}`, {
      method:"GET", mode:"cors"
    });
    if(!r.ok){
      const text = await r.text().catch(()=> "");
      throw new Error(`HTTP ${r.status} – ${text || "Request failed"}`);
    }
    const d = await r.json();

    const isBuzz = Number(d.prediction)===1;

    // הסתברות עם clamp
    const pRaw = Number(d.probability);
    const p = Math.max(0, Math.min(1, isFinite(pRaw) ? pRaw : 0));

    // נרמול סנטימנט
    const s = d.sentiment || {pos:0,neu:0,neg:0,compound:0};
    const sNorm = {
      pos: Math.max(0, Math.min(1, Number(s.pos) || 0)),
      neu: Math.max(0, Math.min(1, Number(s.neu) || 0)),
      neg: Math.max(0, Math.min(1, Number(s.neg) || 0)),
      compound: Number(s.compound) || 0
    };

    // Prediction
    $("predPill").textContent = isBuzz ? "Buzz High potential" : "Buzz Low potential";
    $("predPill").className = "pill sm " + (isBuzz ? "ok" : "bad");


    // Probability (טקסט + פרוגרס בר)
    $("prob").textContent = (p*100).toFixed(2) + "%";
    const fill = $("probFill");
    fill.style.width = (p*100) + "%";
    fill.className = "progress-fill " + (p<0.33 ? "low" : p<0.66 ? "med" : "high");

    // Sentiment badge
    const top = Object.entries({Positive:sNorm.pos, Neutral:sNorm.neu, Negative:sNorm.neg})
      .sort((a,b)=>b[1]-a[1])[0][0];
    $("sent").textContent = top;
    $("sent").className = "pill sm " + (top==="Positive" ? "ok" : top==="Negative" ? "bad" : "muted");

    // ── גרפים ──
    const ctx1=$("probChart").getContext("2d"); if(probChart) probChart.destroy();
    probChart = new Chart(ctx1, {
      type: "doughnut",
      data: {
        labels: ["Success", "Other"],
        datasets: [{ data: [p, 1 - p], backgroundColor: ["#22c55e", "#f87171"] }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,    // חשוב: שיתאים לגובה ה-CSS
        plugins: { legend: { display:false } },
        cutout: "70%",
        layout: { padding: 8 }         // קצת מרווח פנימי
      },
      plugins: [centerTextPlugin((p*100).toFixed(2) + "%")]
    });


    const ctx2=$("sentChart").getContext("2d"); if(sentChart) sentChart.destroy();
    sentChart = new Chart(ctx2, {
      type: "bar",
      data: {
        labels:["Positive","Neutral","Negative"],
        datasets:[{ data:[sNorm.pos, sNorm.neu, sNorm.neg] }]
      },
      options:{
        responsive: true,
        maintainAspectRatio: false,    // חשוב: שיתאים לגובה ה-CSS
        plugins:{ legend:{ display:false } },
        scales:{ y:{ min:0, max:1 } },
        layout: { padding: 8 }
      }
    });


const ACC = 0.70;
document.getElementById("accValue").textContent = `${(ACC*100).toFixed(0)}%`;


    $("results").style.display="grid";
  }catch(e){
    alert("Request failed: " + (e.message || e));
  }finally{
    btn.disabled=false; btn.textContent="Predict";
  }
}

$("go").onclick = predict;

// ===== AI Improver =====
async function improvePost() {
  const txt = $("txt").value.trim();
  if (!txt) { alert("אין טקסט לשדרוג"); return; }

  const btn = $("improveBtn");
  btn.disabled = true;
  const oldLabel = btn.textContent;
  btn.textContent = "מייצר הצעות…";

  try {
    const res = await fetch(`${API_BASE}/improve`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ text: txt })
    });
    const data = await res.json();

    if (!res.ok || !data.ok) {
      const msg = (data && (data.error || data.detail)) || `HTTP ${res.status}`;
      throw new Error(msg);
    }

    document.getElementById("aiTitle").textContent = data.title || "";

    const wrap = document.getElementById("aiSuggestions");
    wrap.innerHTML = "";
    (data.suggestions || []).forEach((s) => {
      const card = document.createElement("div");
      card.style.cssText = "border:1px solid #cfe3cf;background:#fff;padding:10px;border-radius:12px;margin-bottom:8px;white-space:pre-wrap";
      card.textContent = s;

      const copy = document.createElement("button");
      copy.textContent = "העתק ⧉";
      copy.style.cssText = "margin-top:8px;padding:6px 10px;border-radius:8px;border:1px solid #2e5d2e;background:#f3fbf2;cursor:pointer";
      copy.onclick = () => navigator.clipboard.writeText(s);

      card.appendChild(document.createElement("br"));
      card.appendChild(copy);
      wrap.appendChild(card);
    });

    document.getElementById("aiTags").textContent = (data.hashtags || []).join(" ");
    document.getElementById("improveArea").style.display = "block";
  } catch (e) {
    alert("שגיאה ביצירת ההצעות: " + (e.message || e));
  } finally {
    btn.disabled = false;
    btn.textContent = oldLabel;
  }
}

document.getElementById("improveBtn").addEventListener("click", improvePost);
</script>
</body>
</html>














