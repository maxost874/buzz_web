<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Buzz Predictor — Live</title>
<script>
  /* ←← עדכן כאן רק שתי השורות ↓↓↓ */
  const API_BASE = "https://buzz-api-bbtg.onrender.com";      // כתובת ה-API שלך ב-Render
  const DASHBOARD_URL = "https://app.powerbi.com/groups/<workspace-id>/reports/<report-id>/ReportSection?pageName=<page-id>";
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --brand:#2F5597; --bg:#f6f8fa; --ok:#2E7D32; --bad:#C62828; --muted:#616161; }
  body{font-family:system-ui,Segoe UI,Roboto;max-width:900px;margin:24px auto;padding:0 16px;background:var(--bg)}
  h1{margin:0 0 8px} .caption{color:#475569;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
  .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  textarea{width:100%;height:140px;padding:10px;border-radius:10px;border:1px solid #d0d7de}
  button,.btn{padding:10px 16px;border:0;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .pill{padding:6px 10px;border-radius:999px;font-weight:700;background:#eee}
  .pill.ok{color:var(--ok);background:#e8f5e9}.pill.bad{color:var(--bad);background:#fdecec}.pill.muted{color:var(--muted);background:#f3f4f6}
</style>
</head>
<body>
  <h1>Buzz Predictor — Live</h1>
  <div class="caption">הדבק טקסט, לחץ Predict, קבל חיזוי + גרפים. בסוף חזור לדשבורד.</div>

  <div class="card">
    <label>טקסט הפוסט</label>
    <textarea id="txt" placeholder="This post will explode today!"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="go">Predict</button>
      <a class="btn" style="background:#e2e8f0;color:#111" id="back" href="#">← Back to Dashboard</a>
    </div>
  </div>

  <div class="grid" id="results" style="display:none">
    <div class="card">
      <div><strong>Prediction:</strong> <span id="pred">–</span> <span id="predPill" class="pill muted">–</span></div>
      <div style="margin-top:8px"><strong>Probability:</strong> <span id="prob">–</span></div>
      <div style="margin-top:8px"><strong>Sentiment:</strong> <span id="sent" class="pill muted">–</span></div>
    </div>
    <div class="card"><div><strong>Success Probability</strong></div><canvas id="probChart" height="220"></canvas></div>
    <div class="card"><div><strong>Sentiment Breakdown</strong></div><canvas id="sentChart" height="220"></canvas></div>
    <div class="card"><div><strong>Polarity (compound)</strong></div><canvas id="compChart" height="220"></canvas></div>
  </div>

<script>
/* === JS אחד בלבד — בלי כפילויות === */
let probChart, sentChart, compChart;
const $ = id => document.getElementById(id);
$("back").href = DASHBOARD_URL;

function setPill(el,k){ el.className="pill "+(k==="ok"?"ok":k==="bad"?"bad":"muted"); }

async function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
async function wakeApi(maxTries=6){
  for(let i=1;i<=maxTries;i++){
    try{
      const r = await fetch(`${API_BASE}/health`, {method:"GET", mode:"cors"});
      if(r.ok) return true;
    }catch(e){}
    await sleep(i*1000);
  }
  return false;
}

async function predict(){
  const t = $("txt").value.trim();
  if(!t){ alert("הכנס טקסט"); return; }

  const btn=$("go"); btn.disabled=true; btn.textContent="...Predicting";
  try{
    const ok = await wakeApi();               // מעיר את Render אם ישן
    if(!ok) throw new Error("API not responding (health).");

    // ←← שימוש ב-GET כדי להימנע מ-preflight/CORS
    const r = await fetch(`${API_BASE}/predict_qs?text=${encodeURIComponent(t)}`, {
      method:"GET",
      mode:"cors"
    });
    if(!r.ok) throw new Error(await r.text());
    const d = await r.json();

    const isBuzz = Number(d.prediction)===1;
    const p = Number(d.probability)||0;
    const s = d.sentiment||{pos:0,neu:0,neg:0,compound:0};

    $("pred").textContent = isBuzz ? "Buzz" : "No Buzz";
    setPill($("predPill"), isBuzz ? "ok" : "bad");
    $("predPill").textContent = isBuzz ? "High potential" : "Low potential";
    $("prob").textContent = (p*100).toFixed(2)+"%";

    const top = Object.entries({Positive:s.pos, Neutral:s.neu, Negative:s.neg})
                      .sort((a,b)=>b[1]-a[1])[0][0];
    $("sent").textContent = top; setPill($("sent"), top==="Positive"?"ok":top==="Negative"?"bad":"muted");

    // גרפים
    const ctx1=$("probChart").getContext("2d");
    if(probChart) probChart.destroy();
    probChart=new Chart(ctx1,{type:"doughnut",data:{labels:["Success","Other"],datasets:[{data:[p,Math.max(0,1-p)]}]},options:{plugins:{legend:{display:false}},cutout:"70%"}});

    const ctx2=$("sentChart").getContext("2d");
    if(sentChart) sentChart.destroy();
    sentChart=new Chart(ctx2,{type:"bar",data:{labels:["Positive","Neutral","Negative"],datasets:[{data:[s.pos||0,s.neu||0,s.neg||0]}]},options:{plugins:{legend:{display:false}},scales:{y:{suggestedMax:1}}}});

    const ctx3=$("compChart").getContext("2d");
    if(compChart) compChart.destroy();
    compChart=new Chart(ctx3,{type:"bar",data:{labels:["Compound (-1..1)"],datasets:[{data:[(s.compound+1)/2]}]},options:{plugins:{legend:{display:false}},scales:{y:{suggestedMax:1}}}});

    $("results").style.display="grid";
  }catch(e){
    alert("Request failed: " + (e.message || e));
  }finally{
    btn.disabled=false; btn.textContent="Predict";
  }
}
$("go").onclick=predict;
</script>
</body>
</html>
